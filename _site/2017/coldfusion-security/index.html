<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>46bit</title>
<script src="//use.typekit.net/uaf2fos.js"></script>
<script>try{Typekit.load();}catch(e){}</script>

<link rel="stylesheet" href="/css/master.css">
<link rel="alternate" type="application/atom+xml" href="/meta/feed.atom">
<body>
	<div class="wrapper">
		<header class="head">
			<h1><a href="/">46bit</a></h1>
			<nav class="sitenav">
				<ul>
					<li><a href="/">Weblog</a></li>
					<li><a href="/about">About</a></li>
				</ul>
			</nav>
		</header>
		<div class="pagecontent">
			<article>
	<header>
		<h1><a href="/2017/coldfusion-security">Securing legacy ColdFusion: <br>Why Escape Spaces?</a></h1>
		<span class="date">March  1, 2017</span>
		
			<!--<span class="tags">Hacking</span>-->
		
	</header>
	<div class="extended"><p>I’m in my Masters year at the moment, which means I have a lot fewer classes but a lot higher expectations in assignments. I’m also undertaking an MEng project (I’ll write about this sometime.) So I have a lot more unreserved time but a bit more work to do. I’ve been filling one day a week doing security and maintainance work on old ColdFusion web applications.</p>
<p>ColdFusion is an old web technology that Macromedia put out. It’s like you implementated of PHP in HTML tags. For I have been working with it - trying to secure a large number of small webapps built with it in years gone by.</p>
<p>There’s a bit of a problem with securing these legacy apps. They’re a mess, and <strong>ColdFusion is insecure by default.</strong> Let’s take some typical Ruby <code>erb</code> markup: <!--more--></p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">&lt;input name=<span class="st">&quot;forename&quot;</span> value=<span class="st">&quot;&lt;%= forename %&gt;&quot;</span>&gt;</code></pre></div>
<p>The <code>&lt;%= … %&gt;</code> tags automatically escape what’s being printed against XSS. The default case is the safe one. Outputting without escaping has to be explictly specified with the <code>raw</code> function. Sadly, ColdFusion only autoescapes in special cases - and I’ve been warned that even then it isn’t bulletproof.</p>
<div class="sourceCode"><pre class="sourceCode coldfusion"><code class="sourceCode coldfusion">&lt;cfinput name=&quot;forename&quot; value=&quot;#form.forename#&quot;&gt;</code></pre></div>
<p>People running ColdFusion are generally moving to the open source <a href="@TODO">Railo</a> and <a href="@TODO">Lucee</a> servers. These applied a sanity pass to what they should support.</p>
<p>A decision I support is expecting the webapps to work and be secure on both old and new servers. This rules out using anything that was insecure in ColdFusion. It also rules out anything that was new in Railo/Lucee. The intersection of secure and available in both is to import the OSASP ESAPI API.</p>
<div class="sourceCode"><pre class="sourceCode coldfusion"><code class="sourceCode coldfusion">&lt;cfoutput&gt;
    &lt;input name=&quot;forename&quot; value=&quot;#request.esapi.encodeForHTMLAttribute(form.forename)#&quot;&gt;
&lt;/cfoutput&gt;</code></pre></div>
<p>Yuck, huh?</p>
<h2 id="why-escape-spaces-against-xss">Why Escape Spaces against XSS?</h2>
<p>As I found by mistake, the big issue with escaping fields being given to <code>cf</code> tags is that characters like spaces get double escaped. Instead of <code>Stranger Things</code> your prefilled form field now says <code>Stranger&amp;#32;Things</code>. The first pass with the <code>ESAPI</code> escaper encoded a space character to <code>&amp;#32;</code>. The second pass inside <code>cfinput</code> then converted <code>&amp;</code> to <code>&amp;amp;</code>.</p>
<p>You wanted this: <input value="Stranger Things"><br> You get this: <input value="Stranger&amp;#32;Things"></p>
<p>There’s the theory that you’re best off escaping almost any character outside <code>/a-z0-9/i</code>, but I was genuinely surprised that spaces are escaped. I found myself wondering why spaces are escaped against XSS. This seems to be why you need to:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;input</span><span class="ot"> name=</span><span class="st">&quot;forename&quot;</span><span class="ot"> value=</span><span class="er">&lt;</span><span class="st">%=</span><span class="ot"> forename</span> <span class="er">%</span><span class="kw">&gt;</span>&gt;</code></pre></div>
<p>See how there’s no quotation marks for the <code>value</code> attribute? HTML is happy without them. So if you don’t escape spaces people can use that.</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html">forename = 'Stranger<span class="dv">&amp;amp;</span>Things onload=alert(&quot;XSS&quot;)'

<span class="kw">&lt;input</span><span class="ot"> value=</span><span class="st">Stranger</span><span class="dv">&amp;amp;</span><span class="st">Things</span><span class="ot"> onload=</span><span class="st">alert(</span><span class="er">'XSS')</span><span class="kw">&gt;</span></code></pre></div>
<p>I think this fits into Defence In Depth. Attribute tags <em>should</em> have the quotation marks, but mistakes happen and nobody is looking for that particular mistake. You have a problem when it only takes one missing quotation mark to open up your website to XSS. Escaping spaces is therefore quite important.</p>
<p>Given the poor quality of the ecosystem and uncertainly as to behaviour on different platforms, we sensibly avoid all the <code>&lt;cf</code> tags. We can use a <code>cfoutput</code> tag to be able to echo values inside ordinary HTML:</p>
<div class="sourceCode"><pre class="sourceCode coldfusion"><code class="sourceCode coldfusion">&lt;cfoutput&gt;
    &lt;input name=&quot;...&quot; value=&quot;#request.esapi.encodeForHTMLAttribute(form.forename)#&quot;&gt;
&lt;/cfoutput&gt;</code></pre></div>
<p>That</p>
<p>That <code>request.esapi.encodeForHTMLAttribute</code> uses OWASP’s ESAPI library to escape against XSS. It’s lengthy, and we’re using a new server technology. There’s a function ColdFusion offers for this named <code>EncodeForHTMLAttribute</code>. Sadly this too is risky to use: in ColdFusion it isn’t a complete protection against So we could use <code>EncodeForHTML</code></p>
<p>So we can more tersely escape with <code>ESAPI</code></p></div>
</article>

		</div>
	</div>
	<script>
	  // Tracking
	  if (document.location.hostname != "localhost") {
	    // GoSquared
	    var GoSquared = {};
	    GoSquared.acct = "GSN-207291-Q";
	    (function(w){
	      function gs(){
	        w._gstc_lt = +new Date;
	        var d = document, g = d.createElement("script");
	        g.type = "text/javascript";
	        g.src = "//d1l6p2sc9645hc.cloudfront.net/tracker.js";
	        var s = d.getElementsByTagName("script")[0];
	        s.parentNode.insertBefore(g, s);
	      }
	      w.addEventListener ?
	        w.addEventListener("load", gs, false) :
	        w.attachEvent("onload", gs);
	    })(window);

	    // Google Analytics
	    var _gaq = _gaq || [];
	    _gaq.push(['_setAccount', 'UA-22921213-1']);
	    _gaq.push(['_trackPageview']);
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	  }
	</script>
</body>
</html>
